{% assign order = shop.orders[order_id] %}
{% assign id = order.id %}
{% assign email = order.email %}
{% assign name = order.name %}
{% assign order_name = order.name %}
{% assign order_number = order.number %}
{% assign confirmation_number = order.confirmation_number %}

{% assign created_at = order.created_at | date: "%B %d, %Y" %}
{% assign payment_terms = order.payment_terms %}
{% assign tags = order.tags | split: ", " %}

{% capture transactions_json %}
[
  {
    "status": "success",
    "kind": "sale",
    "amount": {{ order.current_total_price | times: 100 }}
  }
] 
{% endcapture %}
{% assign transactions = transactions_json | parse_json %}

{% comment %} TODO
               transaction.payment_details
{% endcomment %}

{% assign tax_price = order.total_tax | times: 100 %}

{% comment %} TODO   
              tax_lines
              tax_line.title
              tax_line.price
              tax_line.rate
              tax_line.rate_percentage
{% endcomment %}

{% assign customer = order.customer %}
{% capture billing_address %}
  {{ order.billing_address.first_name }} {{ order.billing_address.last_name }}
  {{ order.billing_address.address1 }}
  {{ order.billing_address.address2 }}
  <br/>{{ order.billing_address.city }}, {{ order.billing_address.province_code }} {{ order.billing_address.zip }}
  {{ order.billing_address.country }}
{% endcapture %}
{% assign subtotal_price = order.subtotal_price | times: 100 %}

{% comment %} TODO   
              discounts 
              discounts_amount
              discounts_savings
              total_price
              financial_status
{% endcomment %}

{% assign requires_shipping = false %}
{% for line_item in order.line_items %}
  {% if line_item.requires_shipping %}
    {% assign requires_shipping = true %}
    {% break %}
  {% endif %}{% endfor %}

{% comment %} TODO   
              shipping_method.title
              shipping_method.price
{% endcomment %}

{% assign shipping_price = order.total_shipping_price_set.shop_money.amount | times: 100 %}
{% capture shipping_address %} 
  {{ order.shipping_address.first_name }}  {{ order.shipping_address.last_name }}
  {{ order.shipping_address.address1 }}
  {{ order.shipping_address.address2 }}
  <br/>{{ order.shipping_address.city }}, {{ order.shipping_address.province_code }} {{ order.shipping_address.zip }}
  {{ order.shipping_address.country }}
{% endcapture %}
{% comment %} TODO
               Not sure how original_line_price is defined
               line_items
{% endcomment %}
{% capture subtotal_line_items_json %}
[
  {% for line_item in order.line_items %}
    {
      "id": "{{ line_item.id }}",
      "title": "{{ line_item.title }}",
      "quantity": {{ line_item.quantity }},
      "original_line_price": {{ line_item.price | times: line_item.quantity | times: 100 }},  
      "final_line_price": {{ line_item.price | times: line_item.quantity | times: 100 }}
    }
    {% unless forloop.last %},{% endunless %}
  {% endfor %}
]
{% endcapture %}
{% assign subtotal_line_items = subtotal_line_items_json | json %}

{% comment %} TODO   
              note
              attributes
              referring_site
              landing_site
              landing_site_ref
              cancelled
              cancelled_at
              cancel_reason
              "has_high_risks?
              (deprecated)"
              unique_gateways
              location (POS only)
              "fulfilled_line_items
              (deprecated)"
              "unfulfilled_line_items
              (deprecated)"
              b2b?
              customer_order_url
{% endcomment %}

{% assign company = order.company %}
{% assign company_location = order.company.location %}

{% assign po_number = order.po_number %}
{% assign order_status_url = order.order_status_url %}
{% assign discount_applications = order.discount_applications %}

{% assign total_tip = order.total_tip_received | plus: 0 %}
{% assign total_duties = order.current_total_duties_set.shop_money.amount %}{% capture email_title %}
  {% if has_pending_payment %}
    Thank you for your order!
  {% else %}
    Thank you for your purchase!
  {% endif %}
{% endcapture %}
{% capture email_body %}
  {% if has_pending_payment %}
    {% if buyer_action_required %}
      You’ll get a confirmation email after completing your payment.
    {% else %}
      Your payment is being processed. You'll get an email when your order is confirmed.
    {% endif %}
  {% else %}
    {% if requires_shipping %}
    {% case delivery_method %}
        {% when 'pick-up' %}
          You’ll receive an email when your order is ready for pickup.
        {% when 'local' %}
          Hi {{ customer.first_name }}, we're getting your order ready for delivery.
        {% else %}
          We're getting your order ready to be shipped. We will notify you when it has been sent.
      {% endcase %}
        {% if delivery_instructions != blank  %}
          <p><b>Delivery information:</b> {{ delivery_instructions }}</p>
        {% endif %}
       {% if consolidated_estimated_delivery_time %}
        {% if has_multiple_delivery_methods %}
          <h3 class="estimated_delivery__title">Estimated delivery</h3>
          <p>{{ consolidated_estimated_delivery_time }}</p>
        {% else %}
          <p>
            Estimated delivery <b>{{ consolidated_estimated_delivery_time }}</b>
          </p>
        {% endif %}
       {% endif %}
    {% endif %}
  {% endif %}
  {% assign gift_card_line_items = line_items | where: "gift_card" %}
  {% assign found_gift_card_with_recipient_email = false %}
  {% for line_item in gift_card_line_items %}
    {% if line_item.properties["__shopify_send_gift_card_to_recipient"] and line_item.properties["Recipient email"] %}
      {% assign found_gift_card_with_recipient_email = true %}
      {% break %}
    {% endif %}
  {% endfor %}
  {% if found_gift_card_with_recipient_email %}
    <p>Your gift card recipient will receive an email with their gift card code.</p>
  {% elsif gift_card_line_items.first %}
    <p>You’ll receive separate emails for any gift cards.</p>
  {% endif %}
{% endcapture %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>{{ subject }}</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width">
    <style>
      .body,
      .order-list__item__cell > table {
        border-spacing: 0;
        border-collapse: collapse;
      }

      .subtotal-line__value > strong {
        font-size: 24px;
        color: #555;
      }

      .customer-info__item-content > span {
        font-size: 16px;
      }

      .order-list__item-discount-allocation > span {
        font-size: 14px;
        margin-left: -4px;
        color: #999;
      }

      .customer-info__item.customer-info__item--last > h4,
      .customer-info__item > h4 {
        font-weight: 500;
        font-size: 16px;
        color: #555;
        margin: 0 0 5px;
      }

      .customer-info__item.customer-info__item--last > p,
      .customer-info__item > p,
      .subtotal-line__title > p,
      .text > p {
        color: #777;
        line-height: 150%;
        font-size: 16px;
        margin: 0;
      }

      .subtotal-line__title > p {
        line-height: 1.2em;
      }

      .return-label__instruction-step > a,
      .shop-name__text > a {
        font-size: 16px;
        text-decoration: none;
        color: #1990c6;
      }

      .shop-name__text > a {
        font-size: 30px;
        color: #333;
      }

      .disclaimer__subtext > a,
      .link__cell > a {
        font-size: 16px;
        text-decoration: none;
        color: #1990c6;
      }

      .disclaimer__subtext > a {
        font-size: 14px;
      }

      .body {
        height: 100% !important;
        width: 100% !important;
      }

      .header.row {
        width: 100%;
        margin: 40px 0 20px;
      }

      .header__cell {
        font-family: -apple-system
        , BlinkMacSystemFont
        , 'Segoe UI'
        , 'Roboto'
        , 'Oxygen'
        , 'Ubuntu'
        , 'Cantarell'
        , 'Fira Sans'
        , 'Droid Sans'
        , 'Helvetica Neue'
        , sans-serif;
      }

      .container,
      .header.row,
      .row,
      .row.content {
        border-spacing: 0;
        border-collapse: collapse;
      }

      .container {
        width: 560px;
        text-align: left;
        margin: 0 auto;
      }

      .row,
      .row.content {
        width: 100%;
      }

      .shop-name__cell {
        font-family: -apple-system
        , BlinkMacSystemFont
        , 'Segoe UI'
        , 'Roboto'
        , 'Oxygen'
        , 'Ubuntu'
        , 'Cantarell'
        , 'Fira Sans'
        , 'Droid Sans'
        , 'Helvetica Neue'
        , sans-serif;
      }

      .shop-name__text {
        font-weight: 400;
        font-size: 30px;
        color: #333;
        margin: 0;
      }

      .order-number__cell {
        font-family: -apple-system
        , BlinkMacSystemFont
        , 'Segoe UI'
        , 'Roboto'
        , 'Oxygen'
        , 'Ubuntu'
        , 'Cantarell'
        , 'Fira Sans'
        , 'Droid Sans'
        , 'Helvetica Neue'
        , sans-serif;
        text-transform: uppercase;
        font-size: 14px;
        color: #999;
      }

      .order-number__text {
        font-size: 16px;
      }

      .content__cell {
        padding-bottom: 40px;
        border: 0;
      }

      .button.main-action-cell,
      .row.actions {
        border-spacing: 0;
        border-collapse: collapse;
      }

      .row.actions {
        width: 100%;
        margin-top: 20px;
      }

      .actions__cell,
      .button__cell,
      .content__cell {
        font-family: -apple-system
        , BlinkMacSystemFont
        , 'Segoe UI'
        , 'Roboto'
        , 'Oxygen'
        , 'Ubuntu'
        , 'Cantarell'
        , 'Fira Sans'
        , 'Droid Sans'
        , 'Helvetica Neue'
        , sans-serif;
      }

      .button.main-action-cell {
        float: left;
        margin-right: 15px;
      }

      .button__cell {
        border-radius: 4px;
      }

      .button__text {
        font-size: 16px;
        text-decoration: none;
        display: block;
        color: #fff;
        padding: 20px 25px;
      }

      .link.secondary-action-cell {
        border-spacing: 0;
        border-collapse: collapse;
        margin-top: 19px;
      }

      .link__cell,
      .section__cell {
        font-family: -apple-system
        , BlinkMacSystemFont
        , 'Segoe UI'
        , 'Roboto'
        , 'Oxygen'
        , 'Ubuntu'
        , 'Cantarell'
        , 'Fira Sans'
        , 'Droid Sans'
        , 'Helvetica Neue'
        , sans-serif;
      }

      .section__cell {
        padding: 40px 0;
      }

      .order-list__item {
        width: 100%;
      }

      .order-list__item__cell,
      .order-list__product-description-cell {
        font-family: -apple-system
        , BlinkMacSystemFont
        , 'Segoe UI'
        , 'Roboto'
        , 'Oxygen'
        , 'Ubuntu'
        , 'Cantarell'
        , 'Fira Sans'
        , 'Droid Sans'
        , 'Helvetica Neue'
        , sans-serif;
      }

      .order-list__item__cell {
        padding-bottom: 15px;
      }

      .order-list__product-description-cell {
        width: 100%;
      }

      .order-list__item-title {
        font-size: 16px;
        font-weight: 600;
        line-height: 1.4;
        color: #555;
      }

      .order-list__item-variant {
        font-size: 14px;
        color: #999;
      }

      .order-list__price-cell {
        font-family: -apple-system
        , BlinkMacSystemFont
        , 'Segoe UI'
        , 'Roboto'
        , 'Oxygen'
        , 'Ubuntu'
        , 'Cantarell'
        , 'Fira Sans'
        , 'Droid Sans'
        , 'Helvetica Neue'
        , sans-serif;
        white-space: nowrap;
      }

      .order-list__item-price {
        color: #555;
        line-height: 150%;
        font-size: 16px;
        font-weight: 600;
        margin: 0 0 0 15px;
      }

      .order-list__item-discount-allocation {
        font-size: 14px;
        display: block;
        line-height: 1.4;
        color: #555;
        margin: 5px 0 0;
      }

      .discount-tag-icon {
        vertical-align: middle;
        margin-right: 6px;
      }

      .order-list__item-original-price {
        font-size: 14px;
        display: block;
        text-align: right;
        color: #999;
      }

      .row.section,
      .row.subtotal-lines,
      .row.subtotal-table {
        width: 100%;
        border-spacing: 0;
        border-collapse: collapse;
      }

      .row.subtotal-lines {
        margin-top: 15px;
        border-top-width: 1px;
        border-top-color: #e5e5e5;
        border-top-style: solid;
      }

      .subtotal-line__title,
      .subtotal-line__value,
      .subtotal-spacer {
        font-family: -apple-system
        , BlinkMacSystemFont
        , 'Segoe UI'
        , 'Roboto'
        , 'Oxygen'
        , 'Ubuntu'
        , 'Cantarell'
        , 'Fira Sans'
        , 'Droid Sans'
        , 'Helvetica Neue'
        , sans-serif;
      }

      .subtotal-spacer {
        width: 40%;
      }

      .row.subtotal-table {
        margin-top: 20px;
      }

      .subtotal-line__title,
      .subtotal-line__value {
        padding: 5px 0;
      }

      .row.footer,
      .row.subtotal-table.subtotal-table--total {
        width: 100%;
        border-spacing: 0;
        border-collapse: collapse;
        border-top-color: #e5e5e5;
        border-top-style: solid;
      }

      .row.subtotal-table.subtotal-table--total {
        margin-top: 20px;
        border-top-width: 2px;
      }

      .total-discount {
        color: #777;
        line-height: 1.1;
        font-size: 16px;
        margin: 10px 0 0;
      }

      .total-discount--amount {
        font-size: 16px;
        color: #555;
      }

      .customer-info__item {
        font-family: -apple-system
        , BlinkMacSystemFont
        , 'Segoe UI'
        , 'Roboto'
        , 'Oxygen'
        , 'Ubuntu'
        , 'Cantarell'
        , 'Fira Sans'
        , 'Droid Sans'
        , 'Helvetica Neue'
        , sans-serif;
        padding-bottom: 40px;
        width: 50%;
      }

      .customer-info__item-content {
        color: #777;
        line-height: 150%;
        font-size: 16px;
        margin: 0;
      }

      .customer-info__item-credit {
        height: 24px;
        display: inline-block;
        margin-right: 10px;
        margin-top: 5px;
        margin-bottom: -6px;
      }

      .row.footer {
        border-top-width: 1px;
      }

      .footer__cell {
        font-family: -apple-system
        , BlinkMacSystemFont
        , 'Segoe UI'
        , 'Roboto'
        , 'Oxygen'
        , 'Ubuntu'
        , 'Cantarell'
        , 'Fira Sans'
        , 'Droid Sans'
        , 'Helvetica Neue'
        , sans-serif;
        padding: 35px 0;
      }

      .disclaimer__subtext {
        color: #999;
        line-height: 150%;
        font-size: 14px;
        margin: 0;
      }

      .spacer {
        min-width: 600px;
        height: 0;
      }

      .empty-line {
        line-height: 0;
      }

      .customer-info__item.customer-info__item--last {
        padding-bottom: 0;
        width: 50%;
      }

      .customer-info__item.customer-info__item--last,
      .empty-line,
      .subtotal-table__line,
      .subtotal-table__small-space {
        font-family: -apple-system
        , BlinkMacSystemFont
        , 'Segoe UI'
        , 'Roboto'
        , 'Oxygen'
        , 'Ubuntu'
        , 'Cantarell'
        , 'Fira Sans'
        , 'Droid Sans'
        , 'Helvetica Neue'
        , sans-serif;
      }

      .subtotal-table__line {
        border-bottom-width: 1px;
        border-bottom-color: #e5e5e5;
        border-bottom-style: solid;
        height: 1px;
        padding: 0;
      }

      .subtotal-table__small-space {
        height: 10px;
      }

      .subtotal-line__discount {
        font-size: 16px;
        margin-left: 5px;
      }

      .subtotal-line__discount-title {
        font-size: 14px;
        line-height: 1.1;
        margin-left: -4px;
      }

      .text-icon-container {
        border-spacing: 0;
        border-collapse: collapse;
      }

      .text-icon {
        font-family: -apple-system
        , BlinkMacSystemFont
        , 'Segoe UI'
        , 'Roboto'
        , 'Oxygen'
        , 'Ubuntu'
        , 'Cantarell'
        , 'Fira Sans'
        , 'Droid Sans'
        , 'Helvetica Neue'
        , sans-serif;
        padding-bottom: 5px;
        padding-right: 8px;
      }

      .text-icon__image {
        width: 18px;
        height: 18px;
        display: inline-block;
        vertical-align: middle;
      }

      .text {
        font-family: -apple-system
        , BlinkMacSystemFont
        , 'Segoe UI'
        , 'Roboto'
        , 'Oxygen'
        , 'Ubuntu'
        , 'Cantarell'
        , 'Fira Sans'
        , 'Droid Sans'
        , 'Helvetica Neue'
        , sans-serif;
        padding-bottom: 5px;
      }

      .return-creation__subtitle {
        color: #777;
        line-height: 150%;
        font-size: 12px;
        margin: 0;
      }

      .return-creation__subtitle-bold {
        color: #000;
      }

      .return-label__instruction-step {
        font-size: 16px;
        color: #777;
        margin-bottom: 10px;
      }

      .section--margin {
        border-spacing: 0;
        border-collapse: collapse;
        margin: 30px 0 40px;
      }

      .small {
        font-size: 14px;
      }
    </style>
    <style>
      .button__cell {
        background: #1990c6;
      }
      a,
      a:hover,
      a:active,
      a:visited {
        color: #1990c6;
      }
    </style>
  </head>

  <body>
    <table class="body">
      <tr>
        <td>
          <table class="header row">
            <tr>
              <td class="header__cell">
                <center>

                  <table class="container">
                    <tr>
                      <td>

                        <table class="row">
                          <tr>
                            <td class="shop-name__cell">
                              {%- if shop.email_logo_url %}
                                <img
                                  src="{{shop.email_logo_url}}"
                                  alt="{{ shop.name }}"
                                  width="{{ shop.email_logo_width }}">
                              {%- else %}
                                <h1 class="shop-name__text">
                                  <a href="https://{{ shop.domain }}/">{{ shop.name }}</a>
                                </h1>
                              {%- endif %}
                            </td>

                            <td>
                              <tr>
                                <td class="order-number__cell">
                                  <span class="order-number__text">
                                    Order {{ order_name }}
                                  </span>
                                </td>
                              </tr>
                              {%- if po_number %}
                                <tr>
                                  <td class="po-number__cell">
                                    <span class="po-number__text">
                                      PO number #{{ po_number }}</span>
                                  </td>
                                </tr>
                              {%- endif %}
                            </td>
                          </tr>
                        </table>

                      </td>
                    </tr>
                  </table>

                </center>
              </td>
            </tr>
          </table>

          <table class="row content">
            <tr>
              <td class="content__cell">
                <center>
                  <table class="container">
                    <tr>
                      <td>

                        <h2>{{ subject }}</h2>
                        <p>{{ email_body }}</p>
                        {% assign transaction_count = transactions | size %}
                        {% if transaction_count > 0 %}
                          {% for transaction in transactions %}
                            {% if transaction.show_buyer_pending_payment_instructions? %}
                              <p>
                                {{ transaction.buyer_pending_payment_notice }}
                              </p>
                              <p>
                                <table class="row">
                                  <tr>
                                    {% for instruction in transaction.buyer_pending_payment_instructions %}
                                      <td>{{ instruction.header }}</td>
                                    {% endfor %}
                                    <td>Amount</td>
                                  </tr>
                                  <tr>
                                    {% for instruction in transaction.buyer_pending_payment_instructions %}
                                      <td>{{ instruction.value }}</td>
                                    {% endfor %}
                                    <td>{{ transaction.amount | money }}</td>
                                  </tr>
                                </table>
                              </p>
                            {% endif %}
                          {% endfor %}
                        {% endif %}

                        {% if order_status_url %}
                          <table class="row actions">
                            <tr>
                              <td class="empty-line">&nbsp;</td>
                            </tr>
                            <tr>
                              <td class="actions__cell">
                                <table class="button main-action-cell">
                                  <tr>
                                    <td class="button__cell">
                                      <a href="{{ order_status_url }}" class="button__text">View your order</a>
                                    </td>
                                  </tr>
                                </table>
                                {% if shop.url %}
                                  <table class="link secondary-action-cell">
                                    <tr>
                                      <td class="link__cell">or
                                        <a href="https://{{ shop.domain }}/">Visit our store</a>
                                      </td>
                                    </tr>
                                  </table>
                                {% endif %}

                              </td>
                            </tr>
                          </table>

                        {% else %}
                          {% if shop.url %}
                            <table class="row actions">
                              <tr>
                                <td class="actions__cell">
                                  <table class="button main-action-cell">
                                    <tr>
                                      <td class="button__cell">
                                        <a href="https://{{ shop.domain }}/" class="button__text">Visit our store</a>
                                      </td>
                                    </tr>
                                  </table>
                                </td>
                              </tr>
                            </table>
                          {% endif %}

                        {% endif %}

                      </td>
                    </tr>
                  </table>
                </center>
              </td>
            </tr>
          </table>

          <table class="row section">
            <tr>
              <td class="section__cell">
                <center>
                  <table class="container">
                    <tr>
                      <td>
                        <h3>Order summary</h3>
                      </td>
                    </tr>
                  </table>
                  <table class="container">
                    <tr>
                      <td>


                        <table class="row">
                          {% for line in subtotal_line_items %}
                            <tr class="order-list__item">
                              <td class="order-list__item__cell">
                                <table>
                                  <td>
                                    {% if line.image %}
                                      <img
                                        src="{{ line | img_url: 'compact_cropped' }}"
                                        align="left"
                                        width="60"
                                        height="60"
                                        class="order-list__product-image" />
                                    {% endif %}
                                  </td>
                                  <td class="order-list__product-description-cell">
                                    {% if line.product.title %}
                                      {% assign line_title = line.product.title %}
                                    {% else %}
                                      {% assign line_title = line.title %}
                                    {% endif %}

                                    {% if line.quantity < line.quantity %}
                                      {% capture line_display %}
              {{ line.quantity }} of {{ line.quantity }}
            {% endcapture %}
                                    {% else %}
                                      {% assign line_display = line.quantity %}
                                    {% endif %}

                                    <span class="order-list__item-title">{{ line_title }}&nbsp;&times;&nbsp;{{ line_display }}</span><br/>

                                    {% if line.variant.title != 'Default Title' %}
                                      <span class="order-list__item-variant">{{ line.variant.title }}</span><br/>
                                    {% endif %}

                                    {% for group in line.groups %}
                                      <span class="order-list__item-variant">Part of: {{ group.display_title }}</span><br/>
                                    {% endfor %}

                                    {% if line.gift_card and line.properties["__shopify_send_gift_card_to_recipient"] %}
                                      {% for property in line.properties %}
                                        {% assign property_first_char = property.first | slice: 0 %}
                                        {% if property.last != blank and property_first_char != '_' %}
                                          <div class="order-list__item-property">
                                            <dt>{{ property.first }}:</dt>
                                            <dd>
                                              {% if property.last contains '/uploads/' %}
                                                <a
                                                  href="{{ property.last }}"
                                                  class="link"
                                                  target="_blank">
                                                  {{ property.last | split: '/' | last }}
                                                </a>
                                              {% else %}
                                                {{ property.last }}
                                              {% endif %}
                                            </dd>
                                          </div>
                                        {% endif %}
                                      {% endfor %}

                                    {% endif %}

                                    {% if line.selling_plan_allocation %}
                                      <span class="order-list__item-variant">{{ line.selling_plan_allocation.selling_plan.name }}</span><br/>
                                    {% endif %}

                                    {% if line.refunded_quantity > 0 %}
                                      <span class="order-list__item-refunded">Refunded</span>
                                    {% endif %}

                                    {% if line.discount_allocations %}
                                      {% for discount_allocation in line.discount_allocations %}
                                        {% if discount_allocation.discount_application.target_selection != 'all' %}
                                          <p>
                                            <span class="order-list__item-discount-allocation">
                                              <img
                                                src="{{ 'notifications/discounttag.png' | shopify_asset_url }}"
                                                width="18"
                                                height="18"
                                                class="discount-tag-icon" />
                                              <span>
                                                {{ discount_allocation.discount_application.title | upcase }}
                                                (-{{ discount_allocation.amount | money }})
                                              </span>
                                            </span>
                                          </p>
                                        {% endif %}
                                      {% endfor %}
                                    {% endif %}
                                  </td>
                                  <td class="order-list__price-cell">
                                    {% if line.original_line_price != line.final_line_price %}
                                      <del class="order-list__item-original-price">{{ line.original_line_price | money }}</del>
                                    {% endif %}
                                    <p class="order-list__item-price">
                                      {% if line.final_line_price > 0 %}
                                        {{ line.final_line_price | money }}
                                      {% else %}
                                        Free
                                      {% endif %}
                                    </p>
                                  </td>
                                </table>
                              </td>
                            </tr>
                          {% endfor %}
                        </table>

                        <table class="row subtotal-lines">
                          <tr>
                            <td class="subtotal-spacer"></td>
                            <td>
                              <table class="row subtotal-table">


                                {% assign order_discount_count = 0 %}
                                {% assign total_order_discount_amount = 0 %}
                                {% assign has_shipping_discount = false %}

                                {% for discount_application in discount_applications %}
                                  {% if discount_application.target_selection == 'all' and discount_application.target_type == 'line_item' %}
                                    {% assign order_discount_count = order_discount_count | plus: 1 %}
                                    {% assign total_order_discount_amount = total_order_discount_amount | plus: discount_application.total_allocated_amount %}
                                  {% endif %}
                                  {% if discount_application.target_type == 'shipping_line' %}
                                    {% assign has_shipping_discount = true %}
                                    {% assign shipping_discount = discount_application.title %}
                                    {% assign shipping_amount = discount_application.total_allocated_amount %}
                                  {% endif %}
                                {% endfor %}


                                <tr class="subtotal-line">
                                  <td class="subtotal-line__title">
                                    <p>
                                      <span>Subtotal</span>
                                    </p>
                                  </td>
                                  <td class="subtotal-line__value">
                                    <strong>{{ subtotal_price | plus: total_order_discount_amount | money }}</strong>
                                  </td>
                                </tr>


                                {% if order_discount_count > 0 %}
                                  {% if order_discount_count == 1 %}

                                    <tr class="subtotal-line">
                                      <td class="subtotal-line__title">
                                        <p>
                                          <span>Order discount</span>
                                        </p>
                                      </td>
                                      <td class="subtotal-line__value">
                                        <strong>-{{ total_order_discount_amount | money }}</strong>
                                      </td>
                                    </tr>

                                  {% endif %}
                                  {% if order_discount_count > 1 %}

                                    <tr class="subtotal-line">
                                      <td class="subtotal-line__title">
                                        <p>
                                          <span>Order discounts</span>
                                        </p>
                                      </td>
                                      <td class="subtotal-line__value">
                                        <strong>-{{ total_order_discount_amount | money }}</strong>
                                      </td>
                                    </tr>

                                  {% endif %}
                                  {% for discount_application in discount_applications %}
                                    {% if discount_application.target_selection == 'all' and discount_application.target_type != 'shipping_line' %}
                                      <tr class="subtotal-line">
                                        <td class="subtotal-line__title">
                                          <p>
                                            <span class="subtotal-line__discount">
                                              <img
                                                src="{{ 'notifications/discounttag.png' | shopify_asset_url }}"
                                                width="18"
                                                height="18"
                                                class="discount-tag-icon" />
                                              <span class="subtotal-line__discount-title">{{ discount_application.title }} (-{{ discount_application.total_allocated_amount | money }})</span>
                                            </span>
                                          </p>
                                        </td>
                                      </tr>

                                    {% endif %}
                                  {% endfor %}
                                {% endif %}


                                {% if delivery_method == 'pick-up' %}

                                  <tr class="subtotal-line">
                                    <td class="subtotal-line__title">
                                      <p>
                                        <span>Pickup</span>
                                      </p>
                                    </td>
                                    <td class="subtotal-line__value">
                                      <strong>{{ shipping_price | money }}</strong>
                                    </td>
                                  </tr>

                                {% else %}
                                  {% if has_shipping_discount %}

                                    <tr class="subtotal-line">
                                      <td class="subtotal-line__title">
                                        <p>
                                          <span>Shipping</span>
                                        </p>
                                      </td>
                                      <td class="subtotal-line__value">
                                        <strong>Free</strong>
                                      </td>
                                    </tr>

                                    <tr class="subtotal-line">
                                      <td class="subtotal-line__title">
                                        <p>
                                          <span class="subtotal-line__discount">
                                            <img
                                              src="{{ 'notifications/discounttag.png' | shopify_asset_url }}"
                                              width="18"
                                              height="18"
                                              class="discount-tag-icon" />
                                            <span class="subtotal-line__discount-title">{{ shipping_discount }} (-{{ shipping_amount | money }})</span>
                                          </span>
                                        </p>
                                      </td>
                                    </tr>

                                  {% else %}

                                    <tr class="subtotal-line">
                                      <td class="subtotal-line__title">
                                        <p>
                                          <span>Shipping</span>
                                        </p>
                                      </td>
                                      <td class="subtotal-line__value">
                                        <strong>{{ shipping_price | money }}</strong>
                                      </td>
                                    </tr>

                                  {% endif %}

                                {% endif %}

                                {% if total_duties %}

                                  <tr class="subtotal-line">
                                    <td class="subtotal-line__title">
                                      <p>
                                        <span>Duties</span>
                                      </p>
                                    </td>
                                    <td class="subtotal-line__value">
                                      <strong>{{ total_duties | money }}</strong>
                                    </td>
                                  </tr>

                                {% endif %}


                                <tr class="subtotal-line">
                                  <td class="subtotal-line__title">
                                    <p>
                                      <span>Taxes</span>
                                    </p>
                                  </td>
                                  <td class="subtotal-line__value">
                                    <strong>{{ tax_price | money }}</strong>
                                  </td>
                                </tr>


                                {% if total_tip and total_tip > 0 %}

                                  <tr class="subtotal-line">
                                    <td class="subtotal-line__title">
                                      <p>
                                        <span>Tip</span>
                                      </p>
                                    </td>
                                    <td class="subtotal-line__value">
                                      <strong>{{ total_tip | money }}</strong>
                                    </td>
                                  </tr>

                                {% endif %}
                              </table>

                              {% assign transaction_size = 0 %}
                              {% assign transaction_amount = 0 %}
                              {% for transaction in transactions %}
                                {% if transaction.status == "success" %}
                                  {% if transaction.kind == "sale" or transaction.kind == "capture" %}
                                    {% assign transaction_size = transaction_size | plus: 1 %}
                                    {% assign transaction_amount = transaction_amount | plus: transaction.amount %}
                                  {% elsif transaction.kind == "refund" or transaction.kind == "change" %}
                                    {% assign transaction_size = transaction_size | plus: 1 %}
                                    {% assign transaction_amount = transaction_amount | minus: transaction.amount %}
                                  {% endif %}
                                {% endif %}
                              {% endfor %}

                              <table class="row subtotal-table subtotal-table--total">
                                {% if payment_terms and payment_terms.automatic_capture_at_fulfillment == false or b2b? %}
                                  {% assign due_at_date = payment_terms.next_payment.due_at | date: "%b %d, %Y" %}

                                  <tr class="subtotal-line">
                                    <td class="subtotal-line__title">
                                      <p>
                                        <span>Total paid today</span>
                                      </p>
                                    </td>
                                    <td class="subtotal-line__value">
                                      <strong>{{ transaction_amount | money_with_currency }}</strong>
                                    </td>
                                  </tr>

                                  <div class="payment-terms">

                                    <tr class="subtotal-line">
                                      <td class="subtotal-line__title">
                                        <p>
                                          <span>Total due {{ due_at_date }}</span>
                                        </p>
                                      </td>
                                      <td class="subtotal-line__value">
                                        <strong>{{ payment_terms.next_payment.amount_due | money_with_currency }}</strong>
                                      </td>
                                    </tr>

                                  </div>
                                {% elsif transaction_amount != total_price %}

                                  <tr class="subtotal-line">
                                    <td class="subtotal-line__title">
                                      <p>
                                        <span>Total</span>
                                      </p>
                                    </td>
                                    <td class="subtotal-line__value">
                                      <strong>{{ total_price | money_with_currency }}</strong>
                                    </td>
                                  </tr>

                                  <div class="payment-terms">

                                    <tr class="subtotal-line">
                                      <td class="subtotal-line__title">
                                        <p>
                                          <span>Total paid today</span>
                                        </p>
                                      </td>
                                      <td class="subtotal-line__value">
                                        <strong>{{ transaction_amount | money_with_currency }}</strong>
                                      </td>
                                    </tr>

                                  </div>
                                {% else %}

                                  <tr class="subtotal-line">
                                    <td class="subtotal-line__title">
                                      <p>
                                        <span>Total</span>
                                      </p>
                                    </td>
                                    <td class="subtotal-line__value">
                                      <strong>{{ total_price | money_with_currency }}</strong>
                                    </td>
                                  </tr>

                                {% endif %}
                              </table>

                              {% if total_discounts > 0 %}
                                <p class="total-discount">
                                  You saved
                                  <span class="total-discount--amount">{{ total_discounts | money }}</span>
                                </p>
                              {% endif %}

                              {% unless payment_terms %}
                                {% if transaction_size > 1 or transaction_amount < total_price %}
                                  <table class="row subtotal-table">
                                    <tr>
                                      <td colspan="2" class="subtotal-table__line"></td>
                                    </tr>
                                    <tr>
                                      <td colspan="2" class="subtotal-table__small-space"></td>
                                    </tr>

                                    {% for transaction in transactions %}
                                      {% if transaction.status == "success" and transaction.kind == "capture" or transaction.kind == "sale" %}
                                        {% if transaction.payment_details.gift_card_last_four_digits %}
                                          {% capture transaction_name %}Gift card (ending with {{ transaction.payment_details.gift_card_last_four_digits }}){% endcapture %}
                                        {% elsif transaction.payment_details.credit_card_company %}
                                          {% capture transaction_name %}{{ transaction.payment_details.credit_card_company }} (ending in {{ transaction.payment_details.credit_card_last_four_digits }}){% endcapture %}
                                        {% else %}
                                          {% capture transaction_name %}{{ transaction.gateway_display_name }}{% endcapture %}
                                        {% endif %}


                                        <tr class="subtotal-line">
                                          <td class="subtotal-line__title">
                                            <p>
                                              <span>{{ transaction_name }}</span>
                                            </p>
                                          </td>
                                          <td class="subtotal-line__value">
                                            <strong>{{ transaction.amount | money }}</strong>
                                          </td>
                                        </tr>

                                      {% endif %}
                                      {% if transaction.kind == 'refund' %}
                                        {% if transaction.payment_details.gift_card_last_four_digits %}
                                          {% assign refund_method_title = transaction.payment_details.type %}
                                        {% elsif transaction.payment_details.credit_card_company %}
                                          {% assign refund_method_title = transaction.payment_details.credit_card_company %}
                                        {% else %}
                                          {% assign refund_method_title = transaction.gateway %}
                                        {% endif %}


                                        <tr class="subtotal-line">
                                          <td class="subtotal-line__title">
                                            <p>
                                              <span>Refund</span>
                                              <br>
                                              <small>{{ refund_method_title | replace: '_', ' ' | capitalize }}</small>
                                            </p>
                                          </td>
                                          <td class="subtotal-line__value">
                                            <strong>- {{ transaction.amount | money }}</strong>
                                          </td>
                                        </tr>

                                      {% endif %}
                                    {% endfor %}
                                  </table>
                                {% endif %}


                              {% endunless %}
                            </td>
                          </tr>
                        </table>


                      </td>
                    </tr>
                  </table>
                </center>
              </td>
            </tr>
          </table>

          <table class="row section">
            <tr>
              <td class="section__cell">
                <center>
                  <table class="container">
                    <tr>
                      <td>
                        <h3>Customer information</h3>
                      </td>
                    </tr>
                  </table>
                  <table class="container">
                    <tr>
                      <td>

                        <table class="row">
                          <tr>
                            {% if requires_shipping and shipping_address %}
                              <td class="customer-info__item">
                                <h4>Shipping address</h4>
                                {{ shipping_address | format_address }}
                              </td>
                            {% endif %}
                            {% if billing_address %}
                              <td class="customer-info__item">
                                <h4>Billing address</h4>
                                {{ billing_address | format_address }}
                              </td>
                            {% endif %}
                          </tr>
                        </table>
                        <table class="row">
                          <tr>
                            {% if company_location %}
                              <td class="customer-info__item">
                                <h4>Location</h4>
                                <p>
                                  {{ company_location.name }}
                                </p>
                              </td>
                            {% endif %}
                            {% if transaction_size > 0 or payment_terms and payment_terms.automatic_capture_at_fulfillment == false or b2b? %}
                              <td class="customer-info__item">
                                <h4>Payment</h4>
                                <p class="customer-info__item-content">
                                  {% if payment_terms %}
                                    {% assign due_date = payment_terms.next_payment.due_at | default: nil %}
                                    {% if payment_terms.type == 'receipt' or payment_terms.type == 'fulfillment' and payment_terms.next_payment.due_at == nil %}
                                      {{ payment_terms.translated_name }}<br>
                                    {% else %}
                                      {{ payment_terms.translated_name }}: Due {{ due_date | date: format: 'date' }}<br>
                                    {% endif %}
                                  {% endif %}
                                  {% if transaction_size > 0 %}
                                    {% for transaction in transactions %}
                                      {% if transaction.status == "success" or transaction.status == "pending" %}
                                        {% if transaction.kind == "capture" or transaction.kind == "sale" %}
                                          {% if transaction.payment_details.gift_card_last_four_digits %}
                                            <img
                                              src="{{ transaction.payment_details.type | downcase | replace: '_', '-'  | payment_type_img_url }}"
                                              class="customer-info__item-credit"
                                              height="24">
                                            ending with {{ transaction.payment_details.gift_card_last_four_digits }}<br>
                                          {% elsif transaction.payment_details.credit_card_company %}
                                            <img
                                              src="{{ transaction.payment_details.credit_card_company | payment_icon_png_url  }}"
                                              class="customer-info__item-credit"
                                              height="24"
                                              alt="{{ transaction.payment_details.credit_card_company }}">
                                            <span>ending with {{ transaction.payment_details.credit_card_last_four_digits }}</span><br>
                                          {% elsif transaction.gateway_display_name == "Gift card" %}
                                            <img
                                              src="{{ transaction.gateway_display_name | downcase | replace: ' ', '-'  | payment_type_img_url }}"
                                              class="customer-info__item-credit"
                                              height="24">
                                            ending with {{ transaction.payment_details.gift_card.last_four_characters | upcase }}<br>
                                            &emsp;&emsp;&emsp;&nbsp;Gift card balance -
                                            <b>{{ transaction.payment_details.gift_card.balance | money }}</b>
                                          {% elsif transaction.gateway_display_name != "Shop Cash" %}
                                            {{ transaction.gateway_display_name }}<br>
                                          {% endif %}
                                        {% elsif transaction.kind == "authorization" and transaction.gateway_display_name == "Shop Cash" %}
                                          <span>Shop Cash -
                                            <b>{{ transaction.amount | money }}</b>
                                          </span>
                                        {% endif %}
                                      {% endif %}
                                    {% endfor %}
                                  {% endif %}
                                </p>
                              </td>
                            {% endif %}
                          </tr>
                          <tr>
                            {% if requires_shipping and shipping_address %}
                              {% if shipping_method %}
                                <td class="customer-info__item">
                                  <h4>Shipping method</h4>
                                  <p>
                                    {% if delivery_promise_branded_shipping_line %}
                                      {{ delivery_promise_branded_shipping_line }}
                                    {% else %}
                                      {{ shipping_method.title }}
                                    {% endif %}
                                  </p>
                                </td>
                              {% endif %}
                            {% endif %}
                          </tr>
                        </table>

                      </td>
                    </tr>
                  </table>
                </center>
              </td>
            </tr>
          </table>

          <table class="row footer">
            <tr>
              <td class="footer__cell">
                <center>
                  <table class="container">
                    <tr>
                      <td>

                        <p class="disclaimer__subtext">If you have any questions, reply to this email or contact us at
                          <a href="mailto:{{ shop.customer_email }}">{{ shop.customer_email }}</a>
                        </p>
                      </td>
                    </tr>
                  </table>
                </center>
              </td>
            </tr>
          </table>

          <img
            src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQI12NgAAAAAgAB4iG8MwAAABJ0RVh0RVhJRjpPcmllbnRhdGlvbgAxhFjs7wAAAABJRU5ErkJggg=="
            class="spacer"
            height="1" />

        </td>
      </tr>
    </table>
  </body>
</html>